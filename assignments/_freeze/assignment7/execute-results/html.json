{
  "hash": "b886742b47a3d67bfdff91df1c7f125c",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Assignment 7\"\nsubtitle: \"Hierarchical model in Stan\"\nauthor: \"Aki Vehtari et al.\"\nformat: \n  html:\n    toc: true\n    code-tools: true\n    code-line-numbers: true  \n    number-sections: true\n    mainfont: Georgia, serif\n    page-layout: article\neditor: source\nfilters:\n  - includes/assignments.lua \n  - includes/include-code-files.lua \n---\n\n\n\n\n\n\n# General information\n\n**The maximum amount of points from this assignment is 9.**\n\nWe have prepared a **quarto template specific to this assignment ([html](template7.html), [qmd](https://avehtari.github.io/BDA_course_Aalto/assignments/template7.qmd), [pdf](template7.pdf))** to help you get started. \n\n\n:::{.aalto}\nWe recommend you use [jupyter.cs.aalto.fi](https://jupyter.cs.aalto.fi) or the [docker container](docker.html).\n:::\n\n:::{.hint}             \n**Reading instructions**:\n\n- [**The reading instructions for BDA3 Chapter 5**](../BDA3_notes.html#ch5).\n\n\n**Grading instructions:** \n\nThe grading will be done in peergrade. \nAll grading questions and evaluations for this assignment are contained within this document\nin the collapsible **Rubric** blocks.\n\n\n**Installing and using `CmdStanR`:** \n\nSee the [Stan\ndemos](https://avehtari.github.io/BDA_course_Aalto/demos.html) on how to\nuse Stan in R (or Python).\n[Aalto JupyterHub](https://Aalto JupyterHub) has working R and\nCmdStanR/RStan environment and is probably the easiest way to use Stan.\n* To use CmdStanR in [Aalto JupyterHub](https://Aalto JupyterHub):<br>\n  `library(cmdstanr)`<br>\n  `set_cmdstan_path('/coursedata/cmdstan')`\n\nThe Aalto Ubuntu desktops also have the necessary libraries installed.]{.aalto}\n\nTo install Stan on your laptop, run 'install.packages(\\\"cmdstanr\\\",\nrepos = c(\\\"https://mc-stan.org/r-packages/\\\", getOption(\\\"repos\\\")))'\nin R. If you encounter problems, see additional answers in\n[**FAQ**](https://avehtari.github.io/BDA_course_Aalto/FAQ.html). [If you\ndon't succeed in short amount of time, it is probably easier to use\n[Aalto JupyterHub](https://Aalto JupyterHub).]{.aalto}\n\n[If you use `Aalto JupyterHub`, all necessary packages have been\npre-installed.]{.aalto} In your laptop, install package `cmdstanr`. Installation\ninstructions on Linux, Mac and Windows can be found at\n<https://mc-stan.org/cmdstanr/>. Additional useful packages are `loo`,\n`bayesplot` and `posterior` (but you don't need these in this\nassignment). For Python users, `PyStan`, `CmdStanPy`, and `ArviZ`\npackages are useful.\n\nStan manual can be found at <https://mc-stan.org/users/documentation/>.\nFrom this website, you can also find a lot of other useful material\nabout Stan.\n\nIf you edit files ending `.stan` in RStudio, you can click \"Check\" in\nthe editor toolbar to make syntax check. This can significantly speed-up\nwriting a working Stan model.\n\n\n:::\n\n\n\n::: {.callout-important collapse=false}\n# Reporting accuracy\n\n**For posterior statistics of interest, only\nreport digits that are not completely random based on the Monte Carlo standard error (MCSE).**\n\n*Example:* If you estimate $E(\\mu) \\approx 1.234$ with MCSE($E(\\mu)$)\n= 0.01, then the true expectation is likely to be between $1.204$ and\n$1.264$, it makes sense to report $E(\\mu) \\approx 1.2$.\n\nSee Lecture video 4.1, [the chapter\nnotes](../BDA3_notes.html#ch10),\nand [a case\nstudy](https://avehtari.github.io/casestudies/Digits/digits.html) for\nmore information.\n:::\n\n\n::: {.callout-tip collapse=true}\n## Further information\n\n- The recommended tool in this course is R (with the IDE RStudio).\n- Instead of installing R and RStudio on you own computer, see [**how\n  to use R and RStudio remotely**](https://avehtari.github.io/BDA_course_Aalto/FAQ.html#How_to_use_R_and_RStudio_remotely).\n- If you want to install R and RStudio locally,\n  download [R and RStudio](https://posit.co/download/rstudio-desktop/).\n- There are tons of tutorials, videos and introductions to R and\n  RStudio online. You can find some initial hints from [**RStudio\n  Education pages**](https://education.rstudio.com/).\n- When working with R, we recommend writing the report using `quarto` and the provided template.\n  The template includes the formatting instructions and how to include code and figures.\n- Instead of `quarto`, you can use other software to make the PDF\n  report, but the the same instructions for formatting should be used.\n- Report all results in a single, **anonymous** \\*.pdf -file and\n  submit it in [**peergrade.io**](peergrade.io).\n- The course has its own R package `aaltobda` with data and\n  functionality to simplify coding. The package is pre-installed in JupyterHub.\n  To install the package on your own system, run\n  the following code (upgrade=\\\"never\\\" skips question about updating other packages):\n```{.r}\ninstall.packages(\"aaltobda\", repos = c(\"https://avehtari.r-universe.dev\", getOption(\"repos\")))\n```\n-   Many of the exercises can be checked automatically using the R\n    package `markmyassignment` (pre-installed in JupyterHub).\n    Information on how to install and use the\n    package can be found in [the `markmyassignment` documentation](https://cran.r-project.org/web/packages/markmyassignment/vignettes/markmyassignment.html).\n    There is no need to include `markmyassignment` results in the\n    report.\n-   Recommended additional self study exercises for each chapter in BDA3\n    are listed in the course web page. These will help to gain deeper understanding of the topic.\n-   Common questions and answers regarding installation and technical\n    problems can be found in [Frequently Asked Questions\n    (FAQ)](https://avehtari.github.io/BDA_course_Aalto/FAQ.html).\n-   Deadlines for all assignments can be found on the course web page\n    and in Peergrade. You can set email alerts for the deadlines in\n    Peergrade settings.\n-   You are allowed to discuss assignments with your friends, but it is\n    not allowed to copy solutions directly from other students or from\n    internet.\n-   You can copy, e.g., plotting code from the course demos,\n    but really try to solve the actual assignment problems with your own\n    code and explanations.\n-   Do not share your answers publicly.\n-   Do not copy answers from the internet or from previous years. We compare\n    the answers to the answers from previous years and to the answers\n    from other students this year.\n-   Use of AI is allowed on the course, but the most of the work needs to by the student, and you need to report\n    whether you used AI and in which way you used them (See [points 5 and 6 in Aalto guidelines for use of AI in teaching](https://www.aalto.fi/en/services/guidance-for-the-use-of-artificial-intelligence-in-teaching-and-learning-at-aalto-university)).\n-   All suspected plagiarism will be\n    reported and investigated. See more about the [**Aalto University\n    Code of Academic Integrity and Handling Violations\n    Thereof**](https://into.aalto.fi/display/ensaannot/Aalto+University+Code+of+Academic+Integrity+and+Handling+Violations+Thereof).\n-   Do not submit empty PDFs, almost empty PDFs, copy of the questions, nonsense generated by yourself or AI, as these are just\n    harming the other students as they can't do peergrading for the\n    empty or nonsense submissions. Violations of this rule will be\n    reported and investigated in the same way was plagiarism.\n-   If you have any suggestions or improvements to the course material,\n    please post in the course chat feedback channel, create an issue, or\n    submit a pull request to the public repository!\n\n\n:::\n\n\n\n::: {.rubric weight=7.5}\n\n* Can you open the PDF and it's not blank nor nonsense?\nIf the pdf is blank, nonsense, or something like only a copy of the questions, 1) report it as problematic in Peergrade-interface to get another report to review, and 2) send a message to TAs.\n* Is the report anonymous?\n\n:::\n\n\n\n\n\n:::: {.content-hidden when-format=\"pdf\"}\n::: {.callout-tip collapse=true}\n \n## Setup \nThe following loads several needed packages:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(aaltobda)\nlibrary(bayesplot)\nlibrary(cmdstanr)\nlibrary(dplyr)\nlibrary(ggplot2)\nlibrary(ggdist) # for stat_dotsinterval\nlibrary(posterior)\nif(!require(brms)){\n    install.packages(\"brms\")\n    library(brms)\n}\n\n# Set more readable themes with bigger font for plotting packages.\nggplot2::theme_set(theme_minimal(base_size = 14))\nbayesplot::bayesplot_theme_set(theme_minimal(base_size = 14))\n\n# This registers CmdStan as the backend for compiling cmdstan-chunks.\ncheck_cmdstan_toolchain(fix = TRUE, quiet = TRUE)\nregister_knitr_engine(override = FALSE)\n```\n:::\n\n\n\n\n:::\n::::\n\n\n# Hierarchical Model: Chicken Data with Stan (6p)\n\n**Do not look at the secret dataset until you have defined your priors in section 2.1.**\n\nA secret dataset, included in base `r`, contains weight measurements from 50 chicks from their birth until the age of 21 days. For this task, we are interested in modeling the weight of a chick at the age of 12 days.\n\n## Choosing a weakly informative prior by intuition\n\nWe will first guide you through two processes for choosing *weakly* informative priors which you can use in your projects as well (though, if expert knowledge is present, we encourage to use that though instead). Many definitions of *weak* exist, but for our purposes, we intend to set priors in this assignment which don't overwhelm the likelihood contributions to the posterior while still exerting some amount of regularisation.\n\nIn the absence of additional information, we will assume that chick weights at 12 days of age ($w$) follow a normal distribution:\n$$\nw\\sim\\mathcal N (\\mu,\\sigma).\n$$\nOur task will be to define weakly informative priors for the mean $\\mu$ given observation model standard deviation, $\\sigma$ (a prior distribution for $\\sigma$ will be set in after section 2).\n\nHere, $\\mu$ represents the population mean chick weight at 12 days and $\\sigma$ represents the standard-deviation of the chick weights $w$ around that population mean. For this exercise, we will be specifying a normal prior for $\\mu$:\n\n$$\n\\mu\\sim\\mathcal N (\\mu_0,\\sigma_0).\n$$\n\n$\\mu_0$ represents our prior knowledge of what we believe the population weight to be and $\\sigma_0$ represents our level of certainty in this belief. To specify a weakly-informative prior for $\\mu$ we need to select values of $\\mu_0$ and $\\sigma_0$ that imply the range of plausible values that $\\mu$ could take.\n\nWe can do this by our own intuitive prior knowledge (if such intuition exists), or by searching for external references.\n\nDespite the name, weakly informed priors can be quite subjective ([see for more theoretical discussion here](http://www.stat.columbia.edu/~gelman/research/published/entropy-19-00555-v2.pdf)), such that some justification is always needed. For the subtasks below, you will not be graded on the accuracy or precision of your numbers, but on your justification of them. The numerical choices you make should make sense and be understandable to an external reviewer of your work (even if they may not agree with your choices).\n\n\n::: {.callout-caution collapse=\"false\"}\n## A word of caution on eliciting the priors below\nPlease note that in the below, we intend to set a prior on $\\mu$ (the *mean* chick weight), but the intuition we ilicit is based on the weight of *individual* chicks. We do so to help create intuition about what the mean could be, however, it would be theoretically more accurate to ilicit priors about *mean* chick weights. \n:::\n\n:::{.callout-important}\n\nWe have made changes to the assignment text and some of the rubrics to make it clearer.\n\n:::\n\n\n:::{.subtask letter=a}\nBased on your own past experience and estimation skills, what would you guess is a typical weight range of a fully grown chicken in grams? Justify your choice with 1-3 sentences.\n:::\n\n:::{.hint}\nWould it make sense if a chicken weighed 1 million grams? 0.005 grams? What about a chicken that weighed more than you? More than a car? Note that is not important to have a very precise or accurate guess here, the key goal is simply to identify the range of plausible (or at least possible) values.\n:::\n\n::::{.subrubric}\n### Fully grown chicken weight range by intuition\n\n* Does the chosen range meet the following common sense criteria?\n  * The range is always above **...** and below **...**.\n* Is the justification based on some sort of logic, even if you may disagree?\n::::\n\n:::{.subtask}\nAdjust this range for a 12-day old chick and choose a mean $\\mu_0$ for the weakly informed prior of the parameter $\\mu.$ Justify your adjustment and choice with 1-3 sentences.\n:::\n\n::::{.subrubric}\n### 12-day old chick weight range by intuition\n\n* The range is always above **...** and below **...**.\n* Is the justification based on some sort of logic, even if you may disagree?\n:::: \n\nChoosing the prior standard deviation for $\\mu$ requires a little more caution; overconfident (i.e. narrow) priors can have a strong effect on your results,\nwhereas less confident priors are more easily overcome with observed data.\nGiven that overconfidence is a common human bias, a good intuition-based standard deviation should focus on eliminating the impossible values, rather than including the most likely values. \n\n:::{.subtask}\nChoose a conservative lower and upper bound for the weight of any 12-day old chick, with the goal to exclude impossible values. Justify your choice with 1-3 sentences.\n:::\n\n:::{.hint}\nDepending on your choice of range above for a \"typical\" chick, this range excluding the impossible values should be wider.\n:::\n\n::::{.subrubric}\n### Prior standard deviation by intuition\n\n* Does the chosen range meet the following common sense criteria?\n  * The range is always above **...** and below **...**.\n* Is the justification based on some sort of logic, even if you may disagree?\n::::\n\nA common technique to find a weakly informative prior is to have a standard deviation which is an order of magnitude (a factor of 10) larger than a plausible standard deviation of the data.\n\n:::{.subtask}\nWhat do you think is a plausible standard deviation $\\sigma_\\text{plausible}$ of the weight of 12 days-old chicks, based on your ranges stated above? \nUnder the above recommendation, what standard deviation $\\sigma_0$ should you use for your prior for the mean weight $\\mu$?\n:::\n\n::::{.subrubric}\n#### Prior standard deviation by intuition\n\n* Do the two standard deviations meet the following common sense criteria?\n  - Both values are **...**\n* Given the choice of mean from above, the interval $(\\mu_0 - 3\\sigma_0, \\mu_0 + 3\\sigma_0)$ includes **...**.\n::::\n\n\n:::{.subtask}\nWrite down in mathematical form the final prior for the mean weight $\\mu$ you found using this prior definition technique.\n:::\n\n::::{.subrubric}\n### Prior by intuition\n\n* Does the final prior exist in mathematical notation?\n* Does the prior reflect the choices made above (i.e. $\\mu_0, \\sigma_0$)?\n::::\n\n## Choosing a weakly informative prior using external references\n\nNext, we'll use external references to pick the weakly informed prior. This technique is more general and doesn't assume you would have prior knowledge.\n\n:::{.subtask}\nConsult a trustworthy source on the weight range of farm chickens, e.g. books, articles, a farmer friend. If the recommended values are for a fully grown chicken, make a reasonable adjustment for a 12-day old chick. What is the weight range of a 12-day old chicken? Cite your source and justify any adjustments you make to the reference range.\n:::\n\n::::{.subrubric}\n### Weight range by reference\n* Does the reference range meet the following common sense criteria?\n  * The range is always above **...** and below **...**.\n* Is there a citation? If an adjustment was made, was it justified by logic, even if you disagree?\n::::\n\n:::{.subtask}\nBased on this reference range, what will you choose for the mean of our weakly informed prior? Justify your choice with 1-3 sentences.\n:::\n\n::::{.subrubric}\n### Weight range by reference\n\n* Does the mean value meet the following common sense criteria?\n  * The range is always above **...** and below **...**.\n::::\n\nNext we choose the standard deviation of the prior. We could use the same technique as before, but we'll walk you through another common approach. Assume that $99.7\\%$ of all 12-day old chicks fall into the reference range you found. Under our assumption of a normal distribution, this range will encompass values between $\\mu_0 \\pm 3\\sigma_0$. \n\n:::{.subtask}\nAssuming symmetry, use the mean you chose and either the upper or lower bound $b$ of your reference range to solve the correct version of the following equations to find your associated choice of $\\sigma_0$: (show your work)\n\n- For upper bound $b_u$: $Pr(\\mu_0 + 3\\sigma_0 < b_u) \\approx 0.997$, solving for $\\sigma_0$.\n- For lower bound $b_l$: $Pr(\\mu_0 - 3\\sigma_0 > b_l) \\approx 0.997$, solving for $\\sigma_0$.\n:::\n\n::::{.subrubric}\n### Prior standard deviation by reference\n\n* Does the calculated $\\sigma_0$ value meet the following common sense criteria?\n  * The value is above **...** and below **...**.\n* Did they show their work?\n::::\n\n:::{.subtask}\nWrite down in mathematical form the final prior for the mean weight $\\mu$ you found using this prior definition technique.\n:::\n\n::::{.subrubric}\n### Prior by reference\n\n* Does the final prior exist in mathematical notation?\n* Does the prior reflect the choices made above (i.e. $\\mu_0, \\sigma_0$)?\n::::\n\n## Non-normal priors\n\nThe previous steps all assumed we could use a prior which is normally distributed, but this may not always be the correct assumption to make. \n\n:::{.subtask}\nUnder what mathematical/statistical circumstances would a normal distributed prior not make sense? List at least one circumstance.  Are there values that the normal distribution can take on which would not make sense for some types of variables?\n:::\n\n:::{.hint}\nConsider the nature of any variable you are trying to define a prior over.\n:::\n\n::::{.subrubric}\n### Non-normal priors\n\n* Example cases include variables that **...** or variables that **...**\n::::\n\n## Modeling diet effects on chicken weight\n    \nIn addition to chick weights, the data also contains a categorical variable indicating which diet the chick received. In the data file, each column contains the measurements for a single chick at a given point of time.\n\nIn addition to the existing diets, we are interested in the quality of another box of feed (the fifth diet), which a farmer happened to find yesterday at a dark corner of his warehouse. To read in the data and select chicks with age of 12 days, and to have a peek at the first 6 rows, just use:\n\n::::{.callout-important collapse=true}\n# Data inside, don't peek before you have set your priors!\n:::{.callout-important collapse=true}\n# Have you set your priors?\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndata(\"ChickWeight\")\n\nChick12 <- ChickWeight |> filter(Time == 12)\n\nhead(Chick12)\n```\n:::\n\n\n\n:::\n::::\n\nIn the following analysis, we will model the **weight of a chick at the age of 12 days**. We will use the following three Gaussian models:\n\n-   a separate model, in which each diet is modeled individually\n-   a pooled model, in which all measurements are combined and there is no distinction between diets\n-   a hierarchical model, which has a hierarchical structure as described in [BDA3](https://users.aalto.fi/~ave/BDA3.pdf) Section 11.6\n\nAs in the model described in the book, use the same weight standard deviation $\\sigma$ for all the groups in the hierarchical model. In the separate model, however, use separate weight standard deviation $\\sigma_d$ for each diet $d$. You should use weakly informative priors for all your models.\n\nThe provided Stan code below is given as an example of a separate model. Note that the author has left a comment expressing uncertainty about their prior choices. This separate model can be summarized mathematically as\n$$\n\\begin{aligned}\n    \\mu_{d} &\\sim \\pi(\\mu_d)&&\\text{(diet-wise mean weight),}\\\\\n    \\sigma_d &\\sim \\pi(\\sigma_d)&&\\text{(diet-wise standard deviation of diet-wise chicken weights)},\\\\\n    w_{i,d} &\\sim N(\\mu_d,\\sigma_d)&&\\text{(diet-wise chicken weights)}\\\\\n\\end{aligned}\n$$ {#eq-separate}\n\nwith priors \n\n$$\n\\begin{aligned}\n    \\mu_{d} &\\sim N(0,10)&&\\text{(adjust this) and}\\\\\n    \\sigma_d &\\sim\\mathrm{exponential}(.02)&&\\text{(you can keep this).}\n\\end{aligned}\n$$ {#eq-separate-priors}\n\nFor the separate and the pooled models, use one of the weakly informative priors you have derived in 2.1) or 2.2) for the diet-wise mean weights \n$$\\mu_d\\sim \\pi(\\mu_d)=N(\\mu_0,\\sigma_0).$$\nFor the hierarchical model, remember that the parameters in the priors for the diet-wise mean weights itself have to be parameters with their own prior distributions, in our case \n$$\n\\begin{aligned}\n\\mu_d &\\sim N(\\mu,\\tau)&&\\text{(diet-wise mean weights)},\\\\\n\\mu &\\sim \\pi(\\mu)&&\\text{(mean of prior for diet-wise mean weights) and}\\\\\n\\tau &\\sim \\pi(\\tau)&&\\text{(standard deviation of prior for diet-wise mean weights).}\n\\end{aligned}\n$$\n\nUse the prior you have used for the diet-wise mean weights $\\mu_d$ in the separate and pooled models for the prior on the mean of the prior for the diet-wise mean weights \n$$\\mu \\sim \\pi(\\mu) = N(\\mu_0,\\sigma_0)$$\nin the hierarchical model and use \n$$\\tau \\sim \\pi(\\tau) = \\mathrm{exponential}(.02)$$ \nfor the prior on the standard deviation of the prior for the diet-wise mean weights.\n\n```{.stan include=\"additional_files/assignment7/chickens_separate.stan\"}\n```\n\n\n\n\n\n:::{.subtask}\nDescribe the models with mathematical notation (as is done for the separate model above). Also describe in words the difference between the model and the other models.\n:::\n\n\n\n\n\n\n\n\n::::{.subrubric}\n\n* Are the models described using mathematical notation and the difference to other models described in words?\n  - No equations and no description\n  - Description but no equations\n  - Equations but no description\n  - Equations and description\n::::\n\n:::{.subtask}\nImplement the models in Stan and include the code in the report. Use weakly informative priors for all of your models.\n:::\n\n:::{.hint}\nWhen sampling from the posterior of the hierarchical model, you will very likely get a warning about divergent transitions. This tells you that the sampler is having difficulties in sampling the joint posterior and this may lead to biased inference. We will return to this in the next task.\n:::\n\n\n\n\n\n::::{.subrubric}\n### All models\n\n* Is there a related Stan implementation?\n  - No Stan model implemented\n  - Stan model implemented, but it seems clearly wrong or broken\n  - Seemingly valid Stan model implemented\n::::\n\n\n\n\n\n:::{.subtask}\nUse the provided code in the template to\nplot the **posterior distribution of the mean of the weight measurements of the fourth diet** and comment on the possible differences you observe\nbetween the models.\n:::\n\n\n\n::::{.subrubric}\n* Is there a comparison plotted for the posteriors of the mean of diet 4? Does it look something like the model solution plot?\n  -   No comparison plotted\n  -   Comparison plotted but it clearly differs from the example\n  -   Comparison plotted and it approximately matches the example\n* Separate model: Is the result for the separate model discussed?\n  -   The result is not discussed.\n  -   There is some discussion, but it is not mentioned that **...**.\n  -   The result is discussed and the separate model is recognised as **...**.\n* Pooled model: Is the result for the pooled model discussed?\n  -   The result is not discussed.\n  -   There is some discussion, but it is not mentioned that **...**.\n  -   The result is discussed and the pooled model is recognised as **...**.\n* Hierarchical model: Is the result for the hierarchical model discussed?\n  -   The result is not discussed.\n  -   There is some discussion, but it is not mentioned that **...**.\n  -   The result is discussed and the hierarchical model is recognised as **...**.\n::::\n\n:::{.subtask}\nUse the provided code in the template to\nplot the **predictive distribution for another weight measurement from a chick having the fourth diet** and comment on the possible differences you observe\nbetween the models.\n:::\n\n\n\n::::{.subrubric}\n\n* Is there a comparison plotted for the predictive distributions of the weight of a chick with diet 4? Does it look something like the model solution plot?\n  -   No comparison plotted\n  -   Comparison plotted but it clearly differs from the example\n  -   Comparison plotted and it approximately matches the example\n* Separate model: Is the result for the separate model discussed?\n  -   The result is not discussed.\n  -   There is some discussion, but it is not mentioned that **...**.\n  -   The result is discussed and the separate model is recognised as **...**.\n* Pooled model: Is the result for the pooled model discussed?\n  -   The result is not discussed.\n  -   There is some discussion, but it is not mentioned that **...**.\n  -   The result is discussed and the pooled model is recognised as **...**.\n* Hierarchical model: Is the result for the hierarchical model discussed?\n  -   The result is not discussed.\n  -   There is some discussion, but it is not mentioned that **...**.\n  -   The result is discussed and the hierarchical model is recognised as **...**.\n::::\n\n::: {.subtask}\nUse the provided code in the template to\nplot the **posterior distribution of the mean of the weight measurements of a new fifth diet** and comment on the possible differences you observe\nbetween the models.\n:::\n\n\n\n::::{.subrubric}\n* Is there a comparison plotted for the posterior distributions of the mean weight with a new diet? Does it look something like the model solution plot?\n  -   No comparison plotted\n  -   Comparison plotted but it clearly differs from the example\n  -   Comparison plotted and it approximately matches the example\n* Separate model: Is the result for the separate model discussed?\n  -   The result is not discussed.\n  -   There is some discussion, but it is not mentioned that **...**.\n  -   The result is discussed and the separate model is recognised as **...**.\n  -   In addition to the previous option, it is recognised that **...**.\n* Pooled model: Is the result for the pooled model discussed?\n  -   The result is not discussed.\n  -   There is some discussion, but it is not mentioned that **...**.\n    -   The result is discussed and the pooled model is recognised as **...**.\n    -   In addition to the previous option, it is mentioned that **...**.\n* Hierarchical model: Is the result for the hierarchical model discussed?\n  -   The result is not discussed.\n    -   There is some discussion, but it is not mentioned that **...**.\n    -   The result is discussed and the hierarchical model is recognised as **...**.\n::::\n\n:::{.subtask}\nFor each model, report the **posterior expectation for the mean weight of diet 4 with a 90% credible interval**.\n:::\n\n:::{.hint}\nSee the example Stan codes in the demo [Bayesian data analysis - CmdStanR demos: Comparison of $k$ groups with hierarchical models](http://avehtari.github.io/BDA_R_demos/demos_rstan/cmdstanr_demo.html#8_Comparison_of_(k)_groups_with_hierarchical_models) for the comparison of $k$ groups with and without the hierarchical structure.\n:::\n\n::::{.subrubric}\n* For the separate model, is the posterior 90% credible interval for the mean of the fourth diet close to: **...** (small/medium deviation is fine).\n  - No or incorrect answer\n  - Answer is only partially correct\n  - Answers look correct\n* For the pooled model, is the posterior 90% credible interval for the mean of the fourth diet close to: **...** (small/medium deviation is fine).\n  - No answer\n  - Answer is only partially correct\n  - Answer looks correct\n* For the hierarchical model, is the posterior 90% credible interval for the mean of the fourth diet close to: **...** (small/medium deviation is fine).\n  - No answer\n  - Answer is only partially correct.\n  - Answers look correct.\n\n::::\n\n# Hierarchical model with BRMS (3p)\n\n\n:::{.callout-important}\n\nWe have made changes to the assignment text and some of the rubrics to make it clearer.\n\n:::\n\nThe goal of this task is to discuss an alternative parameterisation of hierarchical models and introduce the `brms`-package.\n\n[`brms`](https://paul-buerkner.github.io/brms/) is a high-level interface for Stan providing tools to create a wide range of Bayesian models, including hierarchical ones. In the previous section, you might have noted that with the hierarchical implementation of the model there may be divergent transitions during the sampling from the posterior. This is related to [Neal's funnel](https://mc-stan.org/docs/stan-users-guide/reparameterisation.html), where the sampling algorithm would need to change the step size in order to effectively sample the posterior. One trick to improve sampling is to use an alternative parameterisation for the model. This parameterisation is called the non-centered parameterisation (@eq-non-centered) and often it can help with the divergent transitions. \n\nIn short, we sample parameters from a distribution with a potentially easier geometry for the sampler to explore efficiently and then transform those values to the joint distribution of interest.\n\nThe noncentered parameterisation for the hierarchical model using the diet-wise helper parameter $z_d$ becomes\n\n$$\n\\begin{aligned}\nz_d &\\sim \\operatorname{normal}(0, 1)&&\\text{(diet-wise helper parameter)},\\\\\n\\mu_d &= \\mu + z_d \\tau&&\\text{(diet-wise mean weight)},\\\\\n\\mu &\\sim \\pi(\\mu)&&\\text{(mean of prior for diet-wise mean weights),}\\\\\n\\tau &\\sim \\pi(\\tau)&&\\text{(standard deviation of prior for diet-wise mean weights),}\\\\\n\\sigma &\\sim \\pi(\\sigma)&&\\text{(standard deviation of diet-wise chicken weights) and},\\\\\nw_{i, d} &\\sim \\operatorname{normal}(\\mu_d, \\sigma)&&\\text{(chicken weights)}.\\\\\n\\end{aligned}\n$$ {#eq-non-centered}\n\nThe hierarchical models made with `brms` use this non-centered parameterisation. Your tasks are the following:\n\n:::{.subtask letter=a}\nUse the function in the template to make a scatter plot of the posterior draws given the hierarchical model of the population level standard deviation parameter $\\tau$ and the mean parameter of the fourth diet, $\\mu_4$. The possible divergent transitions are highlighted in red. In the report show the plot and comment if there are any divergent transitions.\n:::\n\n\n\n:::{.subrubric}\n* Is there a scatter plot of $\\sigma_0$ and $\\mu_4$ and some comments provided in the report?\n  - No scatter plot or comments\n  - The scatter plot is included, and divergent transitions are visible, but not commented on.\n  - The scatter plot and comments on the divergences are included.\n:::\n\nTo sample from the posterior given the same model using `brms`, in the template set the weakly informative priors for the hierarchical model you used in the previous task. `brms` has an internal convention to name model parameters and the parameter names from @eq-non-centered map into `brms` names with the following logic:\n\n - $\\mu$ corresponds to `class=\"Intercept\"`\n - $\\tau$ corresponds to `class=\"sd\"`,\n - $\\sigma$ corresponds to `class=\"sigma\"`.\n \n\n:::{.subtask}\nReplace `normal(0,10)` in the `brm` call in the template with your prior for the population mean \n$$\\mu \\sim \\pi(\\mu) = N(\\mu_0,\\sigma_0)$$ \nyou have derived in 2). Then, run the code chunk to sample from the posterior of the hierarchical model using `brms`.\n:::\n\n\n\n::: {.subrubric}\n* Is the `brms` code shown and do the priors agree with the priors specified above?\n:::\n\n:::{.subtask}\nReport the **posterior expectation for the mean weight of diet 4 $\\mu_4$ with a 90% credible interval**, using the code block in the template. How does it compare with your results from the first task?\n:::\n\n\n\n::: {.subrubric}\n* Given the `brms` model, is the posterior 90% credible interval for the mean of the fourth diet close to: **...**(small/medium deviation is fine).\n  - No answer\n  - Answer is only partially correct.\n  - Answers look correct.\n:::\n\n:::{.subtask}\nUse the code in the template to make a **scatter plot of the group standard deviation parameter $\\tau$ and group specific mean parameter**. \n:::\n\n\n\n::: {.subrubric}\n* Is there a scatter plot of $\\tau$ and $\\mu_4$ and some comments provided in the report?\n  - No scatter plot or comments\n  - The scatter plot is included, and divergent transitions are visible, but not commented on.\n  - The scatter plot and comments on the divergences are included.\n:::\n\n:::{.subtask}\nIn your report, address the following questions based on the plots you made for both parameterisations:\n\n - Which of the parameterisations resulted in fewer divergent transitions?\n - Comment for both parameterisations: for which kind of values of $\\tau$, do the divergent transitions occur (if there are any)? It also might be that no clear pattern can be seen.\n - Does centered parameterisation have problems sampling from some specific region of the parameter space compared to the non-centered parameterisation.\n:::\n::: {.subrubric}\n* Has it been discussed which parameterisation resulted in fewer divergent transitions?\n* Has it been discussed for which values of $\\tau$ the divergences occurred?\n* Has it been discussed whether/where the centered parameterisation has problems sampling?\n:::\n\n\n# Overall quality of the report\n\n::: {.rubric weight=7.5}\n\n* Does the report include comment on whether AI was used, and if AI was used, explanation on how it was used?\n    - No\n    - Yes\n* Does the report follow the formatting instructions?\n    - Not at all\n    - Little\n    - Mostly\n    - Yes\n* In case the report doesn't fully follow the general and formatting instructions, specify the instructions that have not been followed. If applicable, specify the page of the report, where this difference is visible. This will help the other student to improve their reports so that they are easier to read and review.\nIf applicable, specify the page of the report, where this difference in formatting is visible.\n* Please also provide feedback on the presentation (e.g. text, layout, flow of the responses, figures, figure captions). Part of the course is practicing making data analysis reports. By providing feedback on the report presentation, other students can learn what they can improve or what they already did well. You should be able to provide constructive or positive feedback for all non-empty and non-nonsense reports. If you think the report is perfect, and you canâ€™t come up with any suggestions how to improve, you can provide feedback on what you liked and why you think some part of the report is better than yours.\n\n\n:::\n\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}